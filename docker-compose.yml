services:
  migrate:
    image: ghcr.io/astral-sh/uv:python3.13-trixie-slim
    user: "${UID:-1000}:${GID:-1000}"
    working_dir: /app
    volumes:
      - ./:/app
      - ./db.sqlite3:/app/db.sqlite3
      - ./media:/app/media
    environment:
      - PYTHONUNBUFFERED=1
      - UV_CACHE_DIR=/tmp/uv-cache
      - XDG_CACHE_HOME=/tmp
      - STATIC_ROOT=/tmp/staticfiles
    command: >
      sh -c "uv sync && uv run python manage.py migrate"
    restart: "no"

  collectstatic:
    image: ghcr.io/astral-sh/uv:python3.13-trixie-slim
    user: "${UID:-1000}:${GID:-1000}"
    working_dir: /app
    volumes:
      - ./:/app
      - ./db.sqlite3:/app/db.sqlite3
      - ./media:/app/media
    environment:
      - PYTHONUNBUFFERED=1
      - UV_CACHE_DIR=/tmp/uv-cache
      - XDG_CACHE_HOME=/tmp
      - STATIC_ROOT=/tmp/staticfiles
    command: >
      sh -c "uv sync && uv run python manage.py collectstatic --noinput"
    restart: "no"
    depends_on:
      migrate:
        condition: service_completed_successfully

  import_manuals:
    image: ghcr.io/astral-sh/uv:python3.13-trixie-slim
    user: "${UID:-1000}:${GID:-1000}"
    working_dir: /app
    volumes:
      - ./:/app
      - ./db.sqlite3:/app/db.sqlite3
      - ./media:/app/media
    environment:
      - PYTHONUNBUFFERED=1
      - UV_CACHE_DIR=/tmp/uv-cache
      - XDG_CACHE_HOME=/tmp
      - STATIC_ROOT=/tmp/staticfiles
    command: >
      sh -c "uv sync && uv run python manage.py import_manual_md docs/manual"
    restart: "no"
    depends_on:
      migrate:
        condition: service_completed_successfully

  web:
    image: ghcr.io/astral-sh/uv:python3.13-trixie-slim
    user: "${UID:-1000}:${GID:-1000}"
    working_dir: /app
    volumes:
      - ./:/app
      - ./db.sqlite3:/app/db.sqlite3
      - ./media:/app/media
    environment:
      - PYTHONUNBUFFERED=1
      - UV_CACHE_DIR=/tmp/uv-cache
      - XDG_CACHE_HOME=/tmp
      - STATIC_ROOT=/tmp/staticfiles
    ports:
      - "8085:8000"
    command: >
      sh -c "uv sync && uv run python manage.py runserver 0.0.0.0:8000"
    depends_on:
      migrate:
        condition: service_completed_successfully
      collectstatic:
        condition: service_completed_successfully
      import_manuals:
        condition: service_completed_successfully

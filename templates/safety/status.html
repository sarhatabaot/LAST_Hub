{% extends "base.html" %}

{% block title %}Safety Status{% endblock %}

{% block sidebar %}
  {% include "partials/sidebar.html" %}
{% endblock %}

{% block content %}
<section class="container">
  <header>
    <article class="safety-card {% if safe %}pico-background-green-500{% elif safe == False %}pico-background-red-500{% else %}pico-background-slate-50{% endif %}">
      <h1 class="safety-status-title {% if safe %}pico-color-white{% elif safe == False %}pico-color-white{% else %}{% endif %}">
        {% if safe %}SAFE{% elif safe == False %}UNSAFE{% else %}UNKNOWN{% endif %}
      </h1>
    </article>
    {% if evaluated_at %}
      <p>
        <strong>Evaluated at:</strong>
        <span id="evaluatedAtUtc" data-evaluated-at="{{ evaluated_at }}">{{ evaluated_at }}</span>
        <small id="evaluatedAtLocal"><em></em></small>
      </p>
    {% endif %}
  </header>

  {% if error %}
    <article>
      <p><strong>Error:</strong> {{ error }}</p>
    </article>
  {% endif %}

  <details class="accordion">
    <summary role="button" class="pico-background-red-400 pico-color-white">
      Failed Reasons ({{ failed_reasons|length }})
    </summary>
    {% if failed_reasons %}
      <ul>
        {% for reason in failed_reasons %}
          <li>{{ reason }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>None.</p>
    {% endif %}
  </details>

  <details class="accordion">
    <summary role="button" class="pico-background-green-400 pico-color-white">
      Passed Reasons ({{ passed_reasons|length }})
    </summary>
    {% if passed_reasons %}
      <ul>
        {% for reason in passed_reasons %}
          <li>{{ reason }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>None.</p>
    {% endif %}
  </details>

  <details class="accordion">
    <summary role="button" class="pico-background-slate-200 pico-color-slate-900">
      Stale Sensors ({{ stale_sensors|length }})
    </summary>
    {% if stale_sensors %}
      <ul>
        {% for sensor in stale_sensors %}
          <li>{{ sensor }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>None.</p>
    {% endif %}
  </details>
</section>

{% if evaluated_at %}
  <script>
    (() => {
      const utcNode = document.getElementById("evaluatedAtUtc");
      const localNode = document.getElementById("evaluatedAtLocal");

      if (!utcNode || !localNode) {
        return;
      }

      const raw = utcNode.dataset.evaluatedAt;
      const parsed = Date.parse(raw);

      if (Number.isNaN(parsed)) {
        return;
      }

      const formatRelative = (seconds) => {
        if (seconds < 10) {
          return "just now";
        }
        if (seconds < 60) {
          return `${seconds} seconds ago`;
        }
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) {
          return `${minutes} minute${minutes === 1 ? "" : "s"} ago`;
        }
        const hours = Math.floor(minutes / 60);
        if (hours < 24) {
          return `${hours} hour${hours === 1 ? "" : "s"} ago`;
        }
        const days = Math.floor(hours / 24);
        return `${days} day${days === 1 ? "" : "s"} ago`;
      };

      const update = () => {
        const localTime = new Date(parsed).toLocaleString();
        const diffSeconds = Math.max(0, Math.round((Date.now() - parsed) / 1000));
        localNode.firstElementChild.textContent =
          ` Local: ${localTime} (${formatRelative(diffSeconds)})`;
      };

      update();
      setInterval(update, 10000);
    })();
  </script>
{% endif %}
{% endblock %}
